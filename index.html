<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Portal</title>
    <link rel="stylesheet" href="styles.css">
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        let currentUser;
        let isAdmin = false;
        let classes = {};
        let attended = {};
        let users = {};
        let selectedUid = null;
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();

        const adminEmail = 'youradmin@gmail.com'; // Replace with your admin email

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                isAdmin = user.email === adminEmail;
                document.getElementById('login').hidden = true;
                document.getElementById('dashboard').hidden = false;
                document.getElementById('user-name').textContent = user.displayName || user.email;
                // Update user info in DB
                update(ref(db, 'users/' + user.uid), {
                    name: user.displayName,
                    email: user.email,
                    lastLogin: new Date().toISOString()
                });
                setPeriod(currentYear, currentMonth);
                onValue(ref(db, 'classes'), snap => {
                    classes = snap.val() || {};
                    updateCalendar();
                    updatePercentage();
                });
                if (isAdmin) {
                    document.getElementById('admin-panel').hidden = false;
                    document.getElementById('percentage').style.display = 'none'; // Admin sees per student
                    onValue(ref(db, 'users'), snap => {
                        users = snap.val() || {};
                        const studentSelect = document.getElementById('student-select');
                        studentSelect.innerHTML = '<option value="">Select Student</option>';
                        Object.entries(users).forEach(([uid, u]) => {
                            if (u.email !== adminEmail) { // Exclude admin
                                const option = document.createElement('option');
                                option.value = uid;
                                option.textContent = u.name || u.email;
                                studentSelect.appendChild(option);
                            }
                        });
                        document.getElementById('student-count').textContent = Object.keys(users).length - 1; // Exclude admin
                    });
                    document.getElementById('student-select').onchange = (e) => {
                        selectedUid = e.target.value;
                        if (selectedUid) {
                            onValue(ref(db, 'attendance/' + selectedUid), snap => {
                                attended = snap.val() || {};
                                updateCalendar();
                                updatePercentage();
                                document.getElementById('percentage').style.display = 'block';
                            });
                        } else {
                            attended = {};
                            updateCalendar();
                            updatePercentage();
                            document.getElementById('percentage').style.display = 'none';
                        }
                    };
                } else {
                    document.getElementById('admin-panel').hidden = true;
                    document.getElementById('percentage').style.display = 'block';
                    onValue(ref(db, 'attendance/' + user.uid), snap => {
                        attended = snap.val() || {};
                        updateCalendar();
                        updatePercentage();
                    });
                }
                updateCalendar();
            } else {
                document.getElementById('login').hidden = false;
                document.getElementById('dashboard').hidden = true;
            }
        });

        document.getElementById('google-login').onclick = () => {
            signInWithPopup(auth, provider);
        };

        document.getElementById('logout').onclick = () => {
            signOut(auth);
        };

        document.getElementById('prev-month').onclick = () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            setPeriod(currentYear, currentMonth);
            updateCalendar();
        };

        document.getElementById('next-month').onclick = () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            setPeriod(currentYear, currentMonth);
            updateCalendar();
        };

        document.getElementById('from-date').onchange = updatePercentage;
        document.getElementById('to-date').onchange = updatePercentage;

        function setPeriod(year, month) {
            const fromDate = new Date(year, month, 1).toISOString().slice(0, 10);
            const toDate = new Date(year, month + 1, 0).toISOString().slice(0, 10);
            document.getElementById('from-date').value = fromDate;
            document.getElementById('to-date').value = toDate;
        }

        function generateCalendar(year, month) {
            document.getElementById('month-year').textContent = new Date(year, month).toLocaleString('default', { month: 'long' }) + ' ' + year;
            const body = document.getElementById('calendar-body');
            body.innerHTML = '';
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            let row = document.createElement('tr');
            let cellCount = 0;
            for (let i = 0; i < firstDay; i++) {
                row.appendChild(document.createElement('td'));
                cellCount++;
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const td = document.createElement('td');
                td.id = 'day-' + day;
                if (isAdmin && selectedUid) {
                    td.onclick = () => handleClick(day);
                } // No onclick for students or without selection
                row.appendChild(td);
                cellCount++;
                if (cellCount % 7 === 0 || day === daysInMonth) {
                    body.appendChild(row);
                    row = document.createElement('tr');
                    cellCount = 0;
                }
            }
        }

        function updateCalendar() {
            generateCalendar(currentYear, currentMonth);
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = new Date(currentYear, currentMonth, day).toISOString().slice(0, 10);
                const classData = classes[dateStr] || [];
                let display = '';
                let colorClass = '';
                if (classData.length > 0) {
                    if (isAdmin && selectedUid) {
                        display = classData.map(c => `${c.count} (${c.name})`).join(', ');
                        colorClass = 'blue';
                    } else {
                        let totalCount = classData.reduce((sum, c) => sum + c.count, 0);
                        let totalAttended = 0;
                        classData.forEach(c => {
                            totalAttended += attended[dateStr + '_' + c.name] || 0;
                        });
                        display = classData.map(c => {
                            const att = attended[dateStr + '_' + c.name] || 0;
                            return `${att}/${c.count} (${c.name})`;
                        }).join(', ');
                        if (totalAttended === totalCount) {
                            colorClass = 'green';
                        } else if (totalAttended > 0) {
                            colorClass = 'yellow';
                        } else {
                            colorClass = 'red';
                        }
                    }
                }
                const td = document.getElementById('day-' + day);
                td.innerHTML = `
                    <div class="day-number">${day}</div>
                    ${display ? `<span class="attendance ${colorClass}">${display}</span>` : ''}
                `;
            }
        }

        function handleClick(day) {
            const dateStr = new Date(currentYear, currentMonth, day).toISOString().slice(0, 10);
            if (isAdmin && selectedUid) {
                const classData = classes[dateStr] || [];
                if (classData.length > 0) {
                    let attendanceInput = '';
                    classData.forEach(c => {
                        const currentAtt = attended[dateStr + '_' + c.name] || 0;
                        attendanceInput += `${c.name}: ${currentAtt}/${c.count}\n`;
                    });
                    const input = prompt(`Mark attendance for ${dateStr} for selected student\n${attendanceInput}Enter as: name1 value1, name2 value2 (e.g., Math 2, Physics 1):`, attendanceInput);
                    if (input !== null) {
                        const attInputs = input.split(',').map(s => s.trim()).filter(s => s);
                        const newAttendance = {};
                        attInputs.forEach(s => {
                            const [name, valueStr] = s.split(' ', 2);
                            const value = parseInt(valueStr);
                            const cls = classData.find(c => c.name === name);
                            if (cls && !isNaN(value) && value >= 0 && value <= cls.count) {
                                newAttendance[dateStr + '_' + name] = value;
                            } else {
                                alert(`Invalid attendance for ${name}. Value must be between 0 and ${cls?.count || 0}.`);
                            }
                        });
                        for (let key in newAttendance) {
                            set(ref(db, 'attendance/' + selectedUid + '/' + key), newAttendance[key]);
                        }
                    }
                } else {
                    alert('No classes scheduled for this date. Set classes first.');
                }
            }
            // Admin can set classes for any date
            if (isAdmin) {
                const currentData = classes[dateStr] || [];
                const currentStr = currentData.map(c => `${c.count} ${c.name}`).join(', ') || 'No classes';
                const input = prompt(`Set classes for ${dateStr}\nCurrent: ${currentStr}\nEnter as: count1 name1, count2 name2 (e.g., 3 Math, 2 Physics):`, currentStr);
                if (input !== null) {
                    const classInputs = input.split(',').map(s => s.trim()).filter(s => s);
                    const newClasses = classInputs.map(s => {
                        const [countStr, name] = s.split(' ', 2);
                        const count = parseInt(countStr);
                        if (isNaN(count) || count < 0) {
                            alert('Invalid count. Please enter a non-negative number.');
                            return null;
                        }
                        if (!name || name.trim() === '') {
                            alert('Please provide a class name.');
                            return null;
                        }
                        return { count: count, name: name.trim() };
                    }).filter(c => c !== null);
                    if (newClasses.length > 0) {
                        set(ref(db, 'classes/' + dateStr), newClasses);
                    } else {
                        alert('No valid classes entered.');
                    }
                }
            }
        }

        function updatePercentage() {
            const from = document.getElementById('from-date').value;
            const to = document.getElementById('to-date').value;
            if (!from || !to) return;
            const startDate = new Date(from);
            const endDate = new Date(to);
            let totalClasses = 0;
            let totalAttended = 0;
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().slice(0, 10);
                const classData = classes[dateStr] || [];
                totalClasses += classData.reduce((sum, c) => sum + c.count, 0);
                classData.forEach(c => {
                    totalAttended += attended[dateStr + '_' + c.name] || 0;
                });
            }
            const percentage = totalClasses > 0 ? (totalAttended / totalClasses * 100).toFixed(2) : 0;
            document.getElementById('percentage').innerHTML = `
                <div class="pie">
                    ${totalAttended}/${totalClasses} (${percentage}%)
                </div>
            `;
        }
    </script>
</head>
<body>
    <div id="login">
        <h1>Attendance Portal</h1>
        <button id="google-login">Login with Google</button>
    </div>
    <div id="dashboard" hidden>
        <header>
            <span id="user-name"></span>
            <button id="logout">Logout</button>
        </header>
        <div id="admin-panel" hidden>
            <h2>Admin Panel</h2>
            <p>Number of Students Logged In: <span id="student-count">0</span></p>
            <label>Select Student: <select id="student-select"></select></label>
        </div>
        <div class="controls">
            <label>From: <input type="date" id="from-date"></label>
            <label>To: <input type="date" id="to-date"></label>
            <div id="percentage" class="percentage"></div>
        </div>
        <div class="calendar">
            <div class="month-nav">
                <button id="prev-month">&lt;</button>
                <span id="month-year"></span>
                <button id="next-month">&gt;</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Sun</th>
                        <th>Mon</th>
                        <th>Tue</th>
                        <th>Wed</th>
                        <th>Thu</th>
                        <th>Fri</th>
                        <th>Sat</th>
                    </tr>
                </thead>
                <tbody id="calendar-body"></tbody>
            </table>
        </div>
    </div>
</body>
</html>
